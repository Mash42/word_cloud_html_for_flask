<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Required link tags -->
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap-grid.min.css">
        <link rel="stylesheet" href="/static/css/bootstrap-reboot.min.css">
        <link rel="stylesheet" href="/static/font/css/open-iconic-bootstrap.css">
        <link rel="stylesheet" href="/static/css/c3.min.css">
        <!-- Required script tags -->
        <script src="/static/js/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
        <script src="/static/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="/static/js/vue_2.6.12.js"></script>
        <script src="/static/js/vuejs-pagenate_2.1.0.js"></script>
        <script src="/static/js/d3.v5.min.js"></script>
        <script src="/static/js/c3.min.js"></script>
        <script src="/static/js/d3.layout.cloud.js"></script>
        <!-- My Custom script tags -->
        <script type="text/javascript">
            $(function (){
                $(".word-cloud-text").on("click", function(){
                    alert($(this).text());
                })
                $(".word-cloud-text").on("mouseover", function(){
                    $(this).addClass("cursor-pointer");
                })
                $(".word-cloud-text").on("mouseout", function(){
                    $(this).removeClass("cursor-pointer");
                })
                
            });
            function alertName(e) {
                alert("クリックされました");
            }
        </script>
        <style>
            .cursor-pointer {
                cursor: pointer;
            }
        </style>
        <title>ワードクラウド</title>
    </head>
    <body>
        <div class="container mt-1" id="app">
            <div class="row">
                <div class="col-6">
                    <form action="/create_word_cloud" method="POST" name="create_word_cloud_form" id="create_word_cloud_form_id">
                        <div class="form-group">
                            <label for="input_sentence_id">文章</label>
                            <textarea name="input_sentence" id="input_sentence_id" rows="10"
                                      class="form-control" required>{{input_sentence}}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">ワードクラウド作成</button>
                    </form>
                </div>
                <div class="col-6 text-center">
                    <label for="wordcloud">ワードクラウド</label>
                    <div id="wordcloud" class="w-100 h-100 border border-primary"></div>
                </div>
                
                <div class="col-12 w-100 h-100">
                    <object type="image/svg+xml" data="/static/word_cloud/word_cloud.svg" class="wordcloud-object" onload="svgLoading()" id="wordcloud-id"></object>
                </div>
            </div>
        </div>
        <script>
            function svgLoading(){
                var svgDoc = document.getElementById('wordcloud-id').getSVGDocument();
                var text_tags = svgDoc.getElementsByTagName("text");
                for(text of text_tags){
                    text.addEventListener("click", function(e){
                        alert(this.innerHTML);
                    })
                }
            }
            {% if word_list %}
            // ワードリスト
            var myWords = []
            {% for word_info in word_list %}
            myWords.push({word:"{{word_info.word}}"
                         ,size:"{{word_info.size}}"
                         ,color:"{{word_info.color}}"
                         })
            {% endfor %}
            
                // グラフの表示設定
                var margin = { top: 10, right: 10, bottom: 10, left: 10 },
                    width = 450 - margin.left - margin.right,
                    height = 300 - margin.top - margin.bottom;
            
                // svgオブジェクトの追加
                var svg = d3.select("#wordcloud").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");
            
                // インスタンスの作成
                var layout = d3.layout.cloud()
                    .size([width, height])
                    .words(myWords.map(function (d) { return { text: d.word, size: d.size, color: d.color }; }))
                    .padding(5)        //単語の距離
                    .rotate(function () { return ~~(Math.random() * 2) * 90; })
                    .fontSize(function (d) { return d.size; })      // フォントサイズ
                    .on("end", draw);
                layout.start();
            
                // 'layoutの出力を受け取り単語を描画
                function draw(words) {
                    svg.append("g").attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                        .selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .style("font-size", function (d) { return d.size; })
                        .attr("fill", function (d) { return d.color;} )
                        .attr("text-anchor", "middle")
                        .style("font-family", "Impact")
                        .attr("class", "word-cloud-text")
                        .attr("transform", function (d) {
                                               return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                                           }
                        )
                        .text(function (d) { return d.text; });
                }
                {% endif %}
        </script>
    </body>
</html>